<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Mini Forest - Odak Takip</title>
</head>
<body>
    <h1>Mini Forest</h1>

    <h2>Yeni Odak Oturumu</h2>
    <label>
        Süre (dakika):
        <input id="durationInput" type="number" value="25" min="1">
    </label>
    <button onclick="startSession()">Başlat</button>
    <button onclick="finishSession()">Bitir</button>

    <p>
        Aktif Oturum ID: <span id="currentSessionId">Yok</span><br>
        Geri Sayım: <span id="timerDisplay">-</span>
    </p>

    <h2>Bugünkü Toplam Süre</h2>
    <button onclick="loadToday()">Bugünü Getir</button>
    <p id="todaySummary">Henüz yüklenmedi.</p>

    <h2>Tüm Oturumlar</h2>
    <button onclick="loadSessions()">Oturumları Getir</button>
    <ul id="sessionsList"></ul>

    <script>
        // Backend adresini buraya yaz:
        // Örneğin: http://localhost:5097
        const BASE_URL = "http://localhost:5097";
        const FOCUS_URL = BASE_URL + "/Focus";

        let currentSessionId = null;
        let timerInterval = null;
        let remainingSeconds = 0;

        async function startSession() {
            const input = document.getElementById("durationInput");
            const minutes = parseInt(input.value, 10);

            if (!minutes || minutes <= 0) {
                alert("Lütfen 0'dan büyük bir süre giriniz.");
                return;
            }

            try {
                const response = await fetch(FOCUS_URL + "/start", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ durationMinutes: minutes })
                });

                const data = await response.json();
                if (!data.success) {
                    alert("Hata: " + data.message);
                    return;
                }

                const session = data.body;
                currentSessionId = session.id;
                document.getElementById("currentSessionId").textContent = currentSessionId;

                startTimer(minutes * 60);
                loadSessions();
                loadToday();
            } catch (err) {
                alert("İstek sırasında hata oluştu: " + err);
            }
        }

        function startTimer(seconds) {
            clearInterval(timerInterval);
            remainingSeconds = seconds;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateTimerDisplay();

                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    if (currentSessionId !== null) {
                        finishSession(true);
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const display = document.getElementById("timerDisplay");
            if (remainingSeconds <= 0) {
                display.textContent = "Süre bitti";
            } else {
                const m = Math.floor(remainingSeconds / 60);
                const s = remainingSeconds % 60;
                display.textContent = m + " dk " + s.toString().padStart(2, "0") + " sn";
            }
        }

        async function finishSession(auto = false) {
            if (currentSessionId === null) {
                if (!auto) alert("Aktif oturum yok.");
                return;
            }

            try {
                const response = await fetch(FOCUS_URL + "/finish/" + currentSessionId, {
                    method: "POST"
                });
                const data = await response.json();
                if (!data.success) {
                    if (!auto) alert("Hata: " + data.message);
                    return;
                }

                clearInterval(timerInterval);
                remainingSeconds = 0;
                updateTimerDisplay();
                currentSessionId = null;
                document.getElementById("currentSessionId").textContent = "Yok";

                if (!auto) {
                    alert("Oturum tamamlandı.");
                }

                loadSessions();
                loadToday();
            } catch (err) {
                if (!auto) alert("İstek sırasında hata oluştu: " + err);
            }
        }

        async function loadToday() {
            try {
                const response = await fetch(FOCUS_URL + "/today");
                const data = await response.json();
                if (!data.success) {
                    document.getElementById("todaySummary").textContent = "Hata: " + data.message;
                    return;
                }

                const body = data.body;
                document.getElementById("todaySummary").textContent =
                    body.date.substring(0, 10) + " tarihinde toplam " +
                    body.totalMinutes + " dakika odaklandınız.";
            } catch (err) {
                document.getElementById("todaySummary").textContent =
                    "İstek sırasında hata oluştu: " + err;
            }
        }

        async function loadSessions() {
            try {
                const response = await fetch(FOCUS_URL);
                const data = await response.json();
                if (!data.success) {
                    alert("Hata: " + data.message);
                    return;
                }

                const list = document.getElementById("sessionsList");
                list.innerHTML = "";

                const sessions = data.body;
                sessions.forEach(s => {
                    const li = document.createElement("li");
                    li.textContent =
                        "ID: " + s.id +
                        " | Süre: " + s.durationMinutes + " dk" +
                        " | Başlangıç: " + new Date(s.startTime).toLocaleString() +
                        " | Durum: " + (s.isCompleted ? "Tamamlandı" : "Devam ediyor");
                    list.appendChild(li);
                });
            } catch (err) {
                alert("İstek sırasında hata oluştu: " + err);
            }
        }

        // Sayfa açılırken
        loadToday();
        loadSessions();
    </script>
</body>
</html>
